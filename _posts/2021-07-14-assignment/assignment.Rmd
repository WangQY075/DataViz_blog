---
title: "Assignment"
description: |
  A short description of the post.
author:
  - name: Qinyu Wang
    url: https://www.linkedin.com/in/qinyu-wang/
date: 07-14-2021
output:
  distill::distill_article:
    distill::distill_article:
    toc: true
    toc_float: true
    self_contained: false
    code_folding: TRUE
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.retina = 3,
                      eval = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

# BACKGROUND
In January 2014, the leaders of GAStech are celebrating their new-found fortune as a result of the initial public offering of their very successful company. In the midst of this celebration, several employees of GAStech go missing.

In Mini-Challenge 2,we will analysis GAStech’s company cars gps records, credit card transactions and loyalty card usage data. From this data, we will identify anomalies and suspicious behaviors and identify which people use which credit and loyalty cards. All questions will be responsed by using visual analysis.

# LITERATURE REVIEW

# METHODOLOGY & DATA PREPARATION

The packages using for this Assignment shows below:

No.|Packages|Function
---|--------|---------
1  |tidyverse|Data cleaning and manipulation 
2  |ggplot2  |ggplot2 is a system for declaratively creating graphics
3  |ggiraph  |ggiraph is a tool that allows you to create dynamic ggplot graphs.
4  |lubridate,clock |


### Library Packages
```{r}
packages = c('tmap', 'clock', 
             'tidyverse','ggplot2','ggiraph',
             'lubridate','ggthemes','viridis','plotly','treemapify','sf',
             'raster','readr','tmap','mapview'
             )
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```

### Import data

```{r}
cc_data<- read.csv('D:/ISSS608 Data Visualization/MC2/MC2/cc_data.csv')

loyalty_data <- read.csv('D:/ISSS608 Data Visualization/MC2/MC2/loyalty_data.csv')

car <- read_csv('D:/ISSS608 Data Visualization/MC2/MC2/gps.csv')
```

### Data Preparation: cc_data
Before any analysis, we first prepared 
```{r}
cc_data$dmy_hm <- date_time_parse(cc_data$timestamp,
                zone = "",
                format = "%m/%d/%Y %H:%M")

cc_data$weekday <- wday(cc_data$dmy_hm, 
                             label = TRUE, 
                             abbr = FALSE)

cc_data$hour <- hour(cc_data$dmy_hm)

cc_data$day <- day(cc_data$dmy_hm)

cc_data$last4ccnum <- as.character(cc_data$last4ccnum)

cc_data <- cc_data %>% 
  group_by(location) %>% 
  mutate(total_price_location = sum(price)) %>% 
  ungroup()

cc_data <- cc_data %>% 
  group_by(last4ccnum,location) %>% 
  mutate(total_price_loccnum = sum(price)) %>% 
  ungroup()

cc_data <- cc_data %>% 
  group_by(last4ccnum) %>% 
  mutate(total_price_ccnum = sum(price)) %>% 
  ungroup()

```

#### Data Preparation: loyalty_data

```{r}

loyalty_data$dmy<- date_time_parse(loyalty_data$timestamp,
                zone = "",
                format = "%m/%d/%Y")

loyalty_data$weekday <- wday(loyalty_data$dmy, 
                             label = TRUE, 
                             abbr = FALSE)

loyalty_data$day <- day(loyalty_data$dmy)

loyalty_data <- loyalty_data %>% 
  group_by(location) %>% 
  mutate(total_price_location = sum(price)) %>% 
  ungroup()

loyalty_data <- loyalty_data %>% 
  group_by(loyaltynum,location) %>% 
  mutate(total_price_lolynum = sum(price)) %>% 
  ungroup()

loyalty_data <- loyalty_data %>% 
  group_by(loyaltynum) %>% 
  mutate(total_price_lynum = sum(price)) %>% 
  ungroup()

```

#### Data Preparation: car_data
```{r}
car$dmy_hm <- date_time_parse(car$Timestamp,
                zone = "",
                format = "%m/%d/%Y %H:%M:%S")

car$day <- day(car$dmy_hm)

car$hour <- hour(car$dmy_hm)

```

### Match credit card and loyatly card record
```{r}
joint_cc_loyalty = cc_data %>% inner_join(loyalty_data,
                                          by=c('location','price','day'))
sum_by_location <- joint_cc_loyalty %>%
select(location, price) %>%
group_by(location) %>%
summarise(total_price = sum(price), total_count = n()) %>%
arrange(desc(total_count), desc(total_price))

colnames(joint_cc_loyalty)[1] <- "timestamp"

new_cc_data <- merge(cc_data, joint_cc_loyalty,
                              by=c('timestamp','location','price','last4ccnum'),all=TRUE)

write.csv(new_cc_data, file = "D:/new_cc_data1.csv", row.names = FALSE)

new_cc_data <- new_cc_data %>% mutate(id = row_number())


new_cc_data<- new_cc_data[-c(507,683,674,497,513,488), ] %>% 
  select(timestamp,location,last4ccnum,loyaltynum,price)

glimpse(new_cc_data)


```


# cc-card number total price by location

```{r}
ggplot(cc_data,aes(x = last4ccnum,y = location,fill = total_price_ccnum))+
  geom_tile(color = 'white',size = 0.1)+
  scale_fill_distiller(palette = "Green",direction = 1)+
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1, 
                                   vjust = .5))
```


#loyalty-card number frequency and total price
```{r}
ggplot(loyalty_data,aes(x = loyaltynum,y = location,fill = total_price_lynum))+
  geom_tile(color = 'white',size = 0.1)+
  scale_fill_distiller(palette = "Green",direction = 1)+
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1, 
                                   vjust = .5))
```


## Bar chart: Frequnecy of Credit Card by Location

```{r}
cc_bar_chart <- cc_data %>% 
  group_by(location) %>% 
  summarise(n = n()) %>% 
  ungroup()

oldvalues <- c("Abila Airport","Abila Scrapyard","Abila Zacharo",
               "Ahaggo Museum","Albert's Fine Clothing",
                "Bean There Done That","Brew've Been Served",
               "Brewed Awakenings","Carlyle Chemical Inc.",
               "Chostus Hotel","Coffee Cameleon","Coffee Shack",
               "Desafio Golf Course","Frank's Fuel",
               "Frydos Autosupply n' More","Gelatogalore",
               "General Grocer","Guy's Gyros","Hallowed Grounds",
               "Hippokampos","Jack's Magical Beans","Kalami Kafenion",
               "Katerina’s Café","Kronos Mart","Kronos Pipe and Irrigation",
               "Maximum Iron and Steel","Nationwide Refinery",
               "Octavio's Office Supplies","Ouzeri Elian",
               "Roberts and Sons","Shoppers' Delight",
               "Stewart and Sons Fabrication","U-Pump")
newvalues <- factor(c("Business","Business","Unknown",
                      "Living","Living","Unknown","Dinning",
                      "Unknown","Business","Living","Dinning",
                      "Dinning","Living","Unknown","Unknown",
                      "Dinning","Living","Dinning","Dinning",
                      "Living","Living","Unknown","Dinning",
                      "Living","Business","Business","Business",
                      "Business","Unknown","Business","Living",
                      "Business","Unknown"
                      ))  # Make this a factor

cc_bar_chart$type <- newvalues[ match(cc_bar_chart$location, oldvalues) ]


p <- ggplot(cc_bar_chart,aes(x = reorder(location,-n), 
                             y = n,fill = type)) + 
  geom_col(color="black") + 
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1, 
                                   vjust = .5))

p <- p + ggtitle("Frequnecy of Credit Card by Location") + 
        labs(y="Frequency", x = "Location")

ggplotly(p)

```





## Bar chart:Frequnecy of Loyalty Card by Location
```{r}
loyalty_bar_chart <- loyalty_data %>% 
  group_by(location) %>% 
  summarise(n = n()) %>% 
  ungroup()

oldvalues <- c("Abila Airport","Abila Scrapyard","Abila Zacharo",
               "Ahaggo Museum","Albert's Fine Clothing",
                "Bean There Done That","Brew've Been Served",
               "Brewed Awakenings","Carlyle Chemical Inc.",
               "Chostus Hotel","Coffee Cameleon","Coffee Shack",
               "Desafio Golf Course","Frank's Fuel",
               "Frydos Autosupply n' More","Gelatogalore",
               "General Grocer","Guy's Gyros","Hallowed Grounds",
               "Hippokampos","Jack's Magical Beans","Kalami Kafenion",
               "Katerina’s Café","Kronos Mart","Kronos Pipe and Irrigation",
               "Maximum Iron and Steel","Nationwide Refinery",
               "Octavio's Office Supplies","Ouzeri Elian",
               "Roberts and Sons","Shoppers' Delight",
               "Stewart and Sons Fabrication","U-Pump")
newvalues <- factor(c("Business","Business","Unknown",
                      "Living","Living","Unknown","Dinning",
                      "Unknown","Business","Living","Dinning",
                      "Dinning","Living","Unknown","Unknown",
                      "Dinning","Living","Dinning","Dinning",
                      "Living","Living","Unknown","Dinning",
                      "Living","Business","Business","Business",
                      "Business","Dinning","Business","Living",
                      "Business","Unknown"
                      ))  # Make this a factor

loyalty_bar_chart$type <- newvalues[ match(loyalty_bar_chart$location, oldvalues) ]



  
p2 <- ggplot(loyalty_bar_chart,aes(x = reorder(location,-n), 
                             y = n,fill = type)) + 
  geom_col(color="black") + 
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1, 
                                   vjust = .5))

p2 <- p2 + ggtitle("Location by frequency loyalty") + 
        labs(y="Frequency", x = "Location")

ggplotly(p2)

```

## Price box plot cc_card
```{r}
ggplot(cc_data, aes(x=price, y=reorder(location,total_price_location))) + 
  geom_boxplot(outlier.colour="tan1")
```

## Price box plot loyalty data
```{r}
g <- ggplot(loyalty_data,aes(x=price,
                             y=reorder(location,total_price_location)))

```




# - when they are popular?
## Heatmap  cc data by weekday and hour
```{r}
plot <- cc_data%>% 
  group_by(location,weekday,hour,) %>% 
  summarise(n = n()) %>% 
  ungroup() 

full_df <- expand.grid(location = unique(cc_data$location),
                       weekday = unique(cc_data$weekday),
                       hour = c(1:23))

plot_full <- plot %>% 
  right_join(
    full_df,
    by = c('location','weekday','hour') 
  ) %>% 
  mutate(hour = as.ordered(hour)) %>% 
  replace_na(list(n = 0L)) %>% 
  filter(location %in% c("Katerina’s Café","Hippokampos",
                          "Abila Airport","Abila Zacharo"))


pwk<- ggplot(plot_full, aes(hour, weekday, fill = n)) + 
geom_tile(color = 'white',size = 0.1) + 
  facet_grid(~location) +
   scale_fill_distiller(palette = "Reds",direction = 1)
pwk
```
  
## Heatmap cc_data by day and hour
```{r}
plot_day <- cc_data%>% 
  group_by(location,day,hour,) %>% 
  summarise(n = n()) %>% 
  ungroup() 

full_df_day <- expand.grid(location = unique(cc_data$location),
                       day = unique(cc_data$day),
                       hour = c(1:23))

plot_full_day <- plot_day %>% 
  right_join(
    full_df_day,
    by = c('location','day','hour') 
  ) %>% 
  mutate(hour = as.ordered(hour)) %>% 
  mutate(day = as.ordered(day)) %>% 
  replace_na(list(n = 0L)) %>% 
  filter(location %in% c("Katerina’s Café","Hippokampos",
                          "Ouzeri Elian","Abila Airport"))


pd <- ggplot(plot_full_day, aes(hour, day, fill = n)) + 
geom_tile(color = 'white',size = 0.1) + 
  facet_grid(~location) +
   scale_fill_distiller(palette = "Reds",direction = 1)

pd
```

## Heatmap car by hour and day
```{r}
car_data <- car %>% 
  group_by(day,hour) %>% 
  summarise(n = n()) %>% 
  ungroup() 

full_df_car <- expand.grid(day = unique(car$day),
                          hour = c(1:23))

plot_full_car <- car_data %>% 
  right_join(
    full_df_car,
    by = c('day','hour') 
  ) %>% 
  mutate(hour = as.ordered(hour)) %>% 
  mutate(day = as.ordered(day)) %>% 
  replace_na(list(n = 0L)) 

ggplot(plot_full_car, aes(hour,day,fill = n)) + 
geom_tile(color = 'white',size = 0.1) + 
   scale_fill_distiller(palette = "Green",direction = 1)

```


Map

```{r}
bgmap <- raster('D:/ISSS608 Data Visualization/MC2/MC2/Geospatial/MC2-tourist.tif')
bgmap
```

```{r}
tmap_mode('plot')
tm_shape(bgmap) +
  tm_raster(bgmap,
            legend.show = FALSE)
```

```{r}
tmap_mode('view')
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
         alpha = NA,
         saturation = 1,
         interpolate = TRUE,
         max.value = 255)
        
```

```{r}
Ablia_st <- st_read(dsn = "D:/ISSS608 Data Visualization/MC2/MC2/Geospatial",
                    layer = 'Abila')
```

## Improting Aspatial Data
```{r}
gps <- read_csv("D:/ISSS608 Data Visualization/MC2/MC2/gps.csv")
glimpse(gps)
```

## Converting Date-Time Field
```{r}
gps$Timestamp <- date_time_parse(gps$Timestamp,
                                 zone = "",
                                 format = "%m/%d/%Y %H:%M:%S")
gps$id <- as_factor(gps$id) 
```

## converting aspatial data into a simple feature data frame
```{r}
gps_sf <- st_as_sf(gps,
                   coords = c("long","lat"),
                   crs = 4326)
```

# creating movement path from GPS Points
```{r}
gps_path <- gps_sf %>%
  group_by(id) %>% 
  summarize(m = mean(Timestamp), ### have problems here
            do_union = FALSE) %>%  
  st_cast("LINESTRING")
#summarie part is meaningless. need this part is only because group_by must have some calculation. but what we really want to do is just group data by id#
```

## plotting the gps paths
```{r}
gps_path_selected <- gps_path %>% 
  filter(id==1)
tmap_mode("view")
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
         alpha = NA,
         saturation = 1,
         interpolate = TRUE,
         max.value = 255) +
  tm_shape(gps_path_selected) + tm_lines()
```



